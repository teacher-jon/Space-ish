<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galaxy Explorer: Balanced Scoring</title>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #0d0e15;
            font-family: 'Courier New', Courier, monospace;
            color: white; touch-action: none; user-select: none; -webkit-user-select: none;
        }

        /* --- UI LAYERS --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; align-items: center;
            z-index: 10;
        }

        #top-hud {
            width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.85);
            text-align: center; border-bottom: 2px solid #00d2d3; 
            box-sizing: border-box; position: relative; pointer-events: auto;
        }

        #level-indicator { color: #ff9ff3; font-weight: bold; font-size: 16px; margin-bottom: 2px; }
        #lives-display { font-size: 20px; margin-bottom: 5px; text-shadow: 0 0 5px red; }
        
        #question-text { 
            font-size: 20px; color: #54a0ff; font-weight: bold; 
            text-shadow: 0 0 10px #54a0ff; margin: 5px 0; line-height: 1.2;
        }
        #sentence-hint { font-size: 14px; font-style: italic; color: #c8d6e5; margin-top: 5px; }
        #score-display { position: absolute; top: 10px; right: 15px; font-size: 18px; color: #feca57; font-weight: bold; }
        #quit-btn {
            position: absolute; top: 10px; left: 10px; pointer-events: auto;
            background: rgba(214, 48, 49, 0.8); border: 1px solid #ff7675;
            color: white; padding: 5px 10px; cursor: pointer; border-radius: 5px;
            font-family: inherit; font-weight: bold; font-size: 11px;
            text-transform: uppercase;
        }

        /* --- CONTROLS --- */
        #touch-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%; height: 180px;
            pointer-events: auto; display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 30px; box-sizing: border-box; 
            z-index: 20; 
        }
        #d-pad {
            display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px;
            gap: 5px; align-items: center; justify-items: center;
        }
        .touch-btn {
            background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; cursor: pointer;
        }
        .touch-btn:active, .touch-btn.pressed { background: rgba(84, 160, 255, 0.6); transform: scale(0.95); border-color: #54a0ff;}
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }
        #fire-btn { 
            background: rgba(238, 82, 83, 0.3); border-color: #ee5253; 
            width: 90px; height: 90px; border-radius: 50%; font-size: 30px; margin-bottom: 15px;
        }
        #fire-btn:active, #fire-btn.pressed { background: rgba(238, 82, 83, 0.8); }

        /* --- SCREENS --- */
        .screen-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(16, 20, 30, 0.98); padding: 25px; border-radius: 20px;
            border: 4px solid #54a0ff; text-align: center; pointer-events: auto;
            z-index: 9999;
            width: 85%; max-width: 600px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .hidden { display: none !important; }
        
        button.menu-btn {
            background: #00d2d3; color: #2d3436; border: none; padding: 15px 30px;
            font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 50px;
            margin-top: 20px; font-family: inherit; width: 100%;
            border: 2px solid white;
        }
        button.menu-btn:active { transform: scale(0.95); background: #55efc4; }

        #player-name {
            background: rgba(0, 0, 0, 0.5); border: 2px solid #00d2d3;
            color: #00d2d3; font-family: 'Courier New', Courier, monospace;
            font-size: 24px; padding: 10px; text-align: center; width: 80%;
            border-radius: 10px; outline: none; text-transform: uppercase; margin-bottom: 10px;
        }

        /* --- WORD BUILDER UI --- */
        #builder-columns {
            display: flex; gap: 5px; justify-content: center; margin: 15px 0;
        }
        .build-col {
            display: flex; flex-direction: column; gap: 5px; width: 33%;
        }
        .col-header { font-size: 12px; color: #81ecec; margin-bottom: 5px; text-transform: uppercase;}
        .part-btn {
            background: #2d3436; border: 1px solid #636e72; color: #dfe6e9;
            padding: 8px 2px; cursor: pointer; font-family: inherit; font-size: 13px;
            border-radius: 5px; transition: 0.2s;
        }
        .part-btn:active { transform: scale(0.95); }
        .part-btn.selected { background: #00cec9; color: black; border-color: white; font-weight: bold; box-shadow: 0 0 10px #00cec9;}
        
        #api-feedback {
            margin-top: 15px; padding: 10px; border-radius: 5px; min-height: 40px;
            font-size: 14px; display: none; text-align: left;
        }
        .api-loading { color: #f1c40f; text-align: center !important; }
        .api-success { background: rgba(0, 184, 148, 0.2); color: #55efc4; border: 1px solid #00b894; }
        .api-error { background: rgba(214, 48, 49, 0.2); color: #ff7675; border: 1px solid #d63031; text-align: center !important; }

        canvas { display: block; }
        #powerup-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: #feca57; font-size: 30px; font-weight: bold; text-shadow: 0 0 20px gold;
            display: none; pointer-events: none; z-index: 100;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="top-hud">
            <button id="quit-btn" onclick="endGame()">‚ö† QUIT</button>
            <div id="level-indicator">LEVEL 1</div>
            <div id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div id="question-text">Loading...</div>
            <div id="sentence-hint">Prepare for launch</div>
            <div id="score-display">0</div>
        </div>
        <div id="powerup-msg">DUAL BLASTERS! ‚≠ê</div>
    </div>

    <div id="touch-controls">
        <div id="d-pad">
            <div class="touch-btn" id="btn-up">‚ñ≤</div>
            <div class="touch-btn" id="btn-left">‚óÄ</div>
            <div class="touch-btn" id="btn-down">‚ñº</div>
            <div class="touch-btn" id="btn-right">‚ñ∂</div>
        </div>
        <div class="touch-btn" id="fire-btn">üî•</div>
    </div>

    <div id="start-screen" class="screen-overlay">
        <h1>üöÄ Galaxy Explorer</h1>
        <p>Please identify yourself, Captain.</p>
        <input type="text" id="player-name" placeholder="ENTER USERNAME" maxlength="12" autocomplete="off">
        <button class="menu-btn" onclick="startGame()">LAUNCH MISSION</button>
    </div>

    <div id="spelling-terminal" class="screen-overlay hidden">
        <h2 style="color:#00cec9">WARP DRIVE ENGAGED</h2>
        <p>Type the password to jump sectors:</p>
        <div style="background:#000; padding:20px; border:2px solid #555; margin:10px 0;">
            <div id="word-definition" style="color:#81ecec; margin-bottom:10px;">DEF</div>
            <span id="typed-input" style="font-size:24px; color:#00cec9; letter-spacing:3px;"></span>
        </div>
        <div id="virtual-keyboard" style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px;"></div>
    </div>

    <div id="word-builder" class="screen-overlay hidden">
        <h2 style="color:#fdcb6e">DATA CORE RETRIEVED!</h2>
        <p style="font-size:14px; margin-bottom:10px;">Select parts to build a word:</p>
        
        <div id="builder-columns">
            <div class="build-col" id="col-prefix">
                <div class="col-header">Prefix</div>
            </div>
            <div class="build-col" id="col-root">
                <div class="col-header">Root</div>
            </div>
            <div class="build-col" id="col-suffix">
                <div class="col-header">Suffix</div>
            </div>
        </div>

        <div id="api-feedback"></div>
        <button class="menu-btn" onclick="submitWordBuild()" style="background:#fdcb6e; color:black;">ANALYZE STRUCTURE</button>
    </div>

    <div id="game-over-screen" class="screen-overlay hidden">
        <h1>Mission Complete!</h1>
        <h2 id="final-score">Score: 0</h2>
        <div id="saving-msg" style="color:#fab1a0; margin-top:10px;"></div>
        <button class="menu-btn" onclick="resetGameUI()">RESTART MISSION</button>
    </div>

<script>
    // --- GAME DATA ---
    const sourceData = [
        { word: "Greenish", def: "Sort of green", sent: "The banana is still ____.", group: "ish" },
        { word: "Reddish", def: "Looks mostly red", sent: "The sunset was ____ orange.", group: "ish" },
        { word: "Helpful", def: "Full of help", sent: "Thank you for being ____.", group: "ful" },
        { word: "Playful", def: "Full of play", sent: "The puppy is very ____.", group: "ful" },
        { word: "Fearless", def: "Without fear", sent: "The hero was ____.", group: "less" },
        { word: "Hopeless", def: "Without hope", sent: "The situation felt ____.", group: "less" },
        { word: "Quickly", def: "In a quick way", sent: "Run ____ to the door!", group: "ly" },
        { word: "Slowly", def: "In a slow way", sent: "The turtle walked ____.", group: "ly" },
        { word: "Kindness", def: "Quality of being kind", sent: "Show ____ to others.", group: "ness" },
        { word: "Unhappy", def: "Not happy", sent: "He was ____ about the rain.", group: "un" }
    ];

    const availableParts = {
        prefixes: ["UN", "RE", "DIS", "PRE", "NONE"],
        roots: ["HELP", "PLAY", "KIND", "VIEW", "HOPE", "COLOR", "USE"],
        suffixes: ["FUL", "ING", "NESS", "ED", "LESS", "LY"]
    };

    const AFFIX_MEANINGS = {
        "UN": "not / opposite of", "RE": "again / back", "DIS": "not / apart", "PRE": "before",
        "FUL": "full of", "ING": "happening now", "NESS": "state of being", "ED": "past tense",
        "LESS": "without", "LY": "in a way (adverb)", "NONE": ""
    };

    function fixSpelling(root, suffix) {
        if (!suffix) return root;
        const r = root.toLowerCase();
        const s = suffix.toLowerCase();
        const vowels = ['a','e','i','o','u','y'];
        const isVowel = (c) => vowels.includes(c);
        const lastChar = r.slice(-1);
        const secondLast = r.slice(-2, -1);
        if (lastChar === 'e' && isVowel(s[0])) return r.slice(0, -1) + s;
        if (lastChar === 'y' && !isVowel(secondLast) && s[0] !== 'i') return r.slice(0, -1) + 'i' + s;
        if (r.length < 4 && !isVowel(lastChar) && isVowel(secondLast) && isVowel(s[0])) return r + lastChar + s;
        return r + s;
    }

    // --- GLOBALS ---
    let gameDeck = [];
    let lives = 3;
    let gameState = 'START';
    let score = 0;
    let wordIndex = 0;
    let currentLevel = 1;
    let lastSpellingIndex = -1;
    let selectedParts = { prefix: "NONE", root: "", suffix: "" };
    
    // Track discovered words so we don't give points twice
    let discoveredWords = new Set();

    const player = { x: 0, y: 0, w: 50, h: 50, speed: 6, color: '#00d2d3', powerupTime: 0, shielded: false };
    let bullets = [], asteroids = [], particles = [], stars = [], powerups = [];
    const keys = { left: false, right: false, up: false, down: false };

    // --- SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
    window.addEventListener('resize', resize); resize();

    // --- AUDIO ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        
        if (type === 'shoot') {
            osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
        } else if (type === 'bonus') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(600, now+0.2);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
        } else if (type === 'hit') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.3);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
        } else {
            osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
        }
        osc.start(); osc.stop(now+0.3);
    }

    // --- INPUT ---
    window.addEventListener('keydown', e => {
        if (gameState === 'PLAYING') {
            if(e.code === 'ArrowLeft') keys.left = true;
            if(e.code === 'ArrowRight') keys.right = true;
            if(e.code === 'ArrowUp') keys.up = true;
            if(e.code === 'ArrowDown') keys.down = true;
            if(e.code === 'Space') fireBullet();
        } else if (gameState === 'SPELLING') {
            handleSpellingKey(e.key);
        }
    });
    window.addEventListener('keyup', e => {
        if(e.code.startsWith('Arrow')) {
            keys.left = false; keys.right = false; keys.up = false; keys.down = false; 
        }
    });

    const dpad = { up: document.getElementById('btn-up'), down: document.getElementById('btn-down'), left: document.getElementById('btn-left'), right: document.getElementById('btn-right') };
    Object.keys(dpad).forEach(k => {
        dpad[k].addEventListener('touchstart', (e)=>{ e.preventDefault(); keys[k]=true; });
        dpad[k].addEventListener('touchend', (e)=>{ e.preventDefault(); keys[k]=false; });
    });
    document.getElementById('fire-btn').addEventListener('touchstart', (e)=>{e.preventDefault(); fireBullet();});

    // --- GAME LOGIC ---
    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        resetGameState();
        gameLoop();
    }

    function resetGameState() {
        score = 0; wordIndex = 0; currentLevel = 1; lives = 3;
        player.x = width/2; player.y = height-100;
        asteroids = []; bullets = []; powerups = [];
        discoveredWords.clear();
        updateLivesDisplay();
        gameDeck = [...sourceData, ...sourceData].sort(()=>Math.random()-0.5);
        stars = Array(80).fill().map(()=>({x:Math.random()*width, y:Math.random()*height, speed:Math.random()*3}));
        gameState = 'PLAYING';
        document.getElementById('ui-layer').style.display = 'flex';
        document.getElementById('touch-controls').style.display = 'flex';
        loadQuestion();
    }

    function resetGameUI() {
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        gameState = 'START';
        asteroids = []; bullets = [];
    }

    function updateLivesDisplay() {
        let display = "";
        for(let i=0; i<lives; i++) display += "‚ù§Ô∏è";
        if(lives === 0) display = "üíÄ";
        document.getElementById('lives-display').innerText = display;
    }

    function spawnParticles(x, y, color) {
        for(let i=0; i<10; i++) particles.push({x:x, y:y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1, color:color});
    }

    function playerTakeDamage() {
        lives--;
        updateLivesDisplay();
        playSound('hit'); 
        spawnParticles(player.x, player.y, 'red');
        if(lives <= 0) endGame();
    }

    function loadQuestion() {
        if(wordIndex >= gameDeck.length) return endGame();
        if(wordIndex > 0 && wordIndex % 5 === 0 && wordIndex !== lastSpellingIndex) return startSpellingChallenge();
        
        const data = gameDeck[wordIndex];
        document.getElementById('question-text').innerText = "TARGET: " + data.def;
        document.getElementById('sentence-hint').innerText = '"' + data.sent + '"';
        document.getElementById('level-indicator').innerText = "LEVEL " + currentLevel;
        document.getElementById('score-display').innerText = score;
        spawnAsteroids(data);
    }

    function spawnBonusItem() {
        powerups.push({
            x: Math.random()*(width-40)+20, y: -50, size: 30, speed: 2, 
            type: 'DATA_CORE', color: '#0984e3', symbol: '?'
        });
    }

    function activatePowerup(p) {
        if(p.type === 'DATA_CORE') openWordBuilder();
    }

    function openWordBuilder() {
        gameState = 'BUILDER';
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('touch-controls').style.display = 'none';
        document.getElementById('word-builder').classList.remove('hidden');
        selectedParts = { prefix: "NONE", root: "", suffix: "" };
        renderBuilderCols();
        document.getElementById('api-feedback').style.display = 'none';
    }

    function renderBuilderCols() {
        const createBtns = (arr, type, containerId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="col-header">${type}</div>`;
            arr.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'part-btn';
                if(item === "NONE") btn.innerText = "(None)";
                else btn.innerText = item;
                if (selectedParts[type.toLowerCase()] === item) btn.classList.add('selected');
                btn.onclick = () => { selectedParts[type.toLowerCase()] = item; renderBuilderCols(); };
                container.appendChild(btn);
            });
        };
        createBtns(availableParts.prefixes, "Prefix", "col-prefix");
        createBtns(availableParts.roots, "Root", "col-root");
        createBtns(availableParts.suffixes, "Suffix", "col-suffix");
    }

    async function submitWordBuild() {
        const feedbackEl = document.getElementById('api-feedback');
        feedbackEl.style.display = 'block';
        feedbackEl.className = 'api-loading';
        feedbackEl.innerText = "Connecting to Dictionary Database...";
        
        let p = selectedParts.prefix === "NONE" ? "" : selectedParts.prefix;
        let r = selectedParts.root;
        let s = selectedParts.suffix;
        let combinedEnd = fixSpelling(r, s);
        let constructedWord = p + combinedEnd;
        let finalWord = constructedWord.toLowerCase();

        // ALREADY DISCOVERED CHECK
        if (discoveredWords.has(finalWord)) {
            feedbackEl.className = 'api-error';
            feedbackEl.innerHTML = `‚ö†Ô∏è <b>"${finalWord.toUpperCase()}"</b> has already been discovered!<br>Try finding a new word.`;
            return;
        }

        try {
            let response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${finalWord}`);
            if (!response.ok) throw new Error("Word not found");
            const data = await response.json();
            const definition = data[0].meanings[0].definitions[0].definition;
            const pos = data[0].meanings[0].partOfSpeech;

            let explanation = `Root <b>${r}</b> `;
            if(p) explanation += `modified by <b>${p}-</b> (${AFFIX_MEANINGS[p]}) `;
            if(s) explanation += `and <b>-${s}</b> (${AFFIX_MEANINGS[s]})`;
            if(!p && !s) explanation += "is the base word.";
            if(combinedEnd.toLowerCase() !== (r+s).toLowerCase()) explanation += " <br><i>(Spelling rule applied!)</i>";

            // CALCULATE POINTS (MAX 50)
            // Base 10 + 3 points per letter
            let wordLengthScore = finalWord.length * 3; 
            let totalPoints = 10 + wordLengthScore;
            
            // Cap at 50
            if(totalPoints > 50) totalPoints = 50;

            // Add to discovered list
            discoveredWords.add(finalWord);

            feedbackEl.className = 'api-success';
            feedbackEl.innerHTML = `
                <div style="font-size:18px; font-weight:bold; margin-bottom:5px;">‚úÖ ${finalWord.toUpperCase()}</div>
                <div style="font-size:14px; font-weight:bold; color:#00b894; margin-bottom:5px;">+${totalPoints} Points!</div>
                <div style="font-size:12px; margin-bottom:5px;">${pos}: ${definition}</div>
                <div style="font-size:11px; color:#2d3436; background:rgba(255,255,255,0.5); padding:5px; border-radius:4px;">${explanation}</div>
            `;
            playSound('bonus');
            score += totalPoints; 
            
            setTimeout(() => {
                document.getElementById('word-builder').classList.add('hidden');
                document.getElementById('ui-layer').style.display = 'flex';
                document.getElementById('touch-controls').style.display = 'flex';
                gameState = 'PLAYING';
            }, 3500);

        } catch (error) {
            feedbackEl.className = 'api-error';
            feedbackEl.innerHTML = `‚ùå <b>"${finalWord.toUpperCase()}"</b> is not in the dictionary.<br>Try a different combination.`;
            score = Math.max(0, score - 5);
        }
    }

    // --- SPELLING ---
    let targetSpellingWord = "", currentTypedWord = "";
    function startSpellingChallenge() {
        gameState = 'SPELLING';
        lastSpellingIndex = wordIndex;
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('touch-controls').style.display = 'none';
        const data = gameDeck[wordIndex-1];
        targetSpellingWord = data.word.toUpperCase();
        currentTypedWord = "";
        document.getElementById('spelling-terminal').classList.remove('hidden');
        document.getElementById('word-definition').innerText = data.def;
        updateTypedDisplay();
        const kb = document.getElementById('virtual-keyboard');
        kb.innerHTML = '';
        "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(char => {
            let key = document.createElement('div');
            key.style.cssText = "background:#333; color:white; padding:10px; width:30px; border-radius:5px; cursor:pointer;";
            key.innerText = char;
            key.onclick = () => handleSpellingKey(char);
            kb.appendChild(key);
        });
        let bs = document.createElement('div');
        bs.innerText = "‚å´"; bs.style.cssText = "background:#d63031; color:white; padding:10px; width:30px; border-radius:5px; cursor:pointer;";
        bs.onclick = () => handleSpellingKey("Backspace");
        kb.appendChild(bs);
    }

    function handleSpellingKey(key) {
        if(key === "Backspace") currentTypedWord = currentTypedWord.slice(0, -1);
        else if(key.length === 1 && key.match(/[a-zA-Z]/) && currentTypedWord.length < targetSpellingWord.length) currentTypedWord += key.toUpperCase();
        updateTypedDisplay();
        if(currentTypedWord === targetSpellingWord) {
            setTimeout(() => {
                currentLevel++;
                document.getElementById('spelling-terminal').classList.add('hidden');
                document.getElementById('ui-layer').style.display = 'flex';
                document.getElementById('touch-controls').style.display = 'flex';
                gameState = 'PLAYING';
                loadQuestion();
            }, 500);
        }
    }

    function updateTypedDisplay() {
        document.getElementById('typed-input').innerText = currentTypedWord + "_";
    }

    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    function endGame() { gameState='GAMEOVER'; document.getElementById('game-over-screen').classList.remove('hidden'); document.getElementById('final-score').innerText = "Score: " + score; }

    function update() {
        if(gameState !== 'PLAYING') return;
        if(keys.left && player.x > 30) player.x -= player.speed;
        if(keys.right && player.x < width-30) player.x += player.speed;
        if(keys.up && player.y > 30) player.y -= player.speed;
        if(keys.down && player.y < height-30) player.y += player.speed;

        for(let i=bullets.length-1; i>=0; i--) {
            bullets[i].y -= bullets[i].speed;
            if(bullets[i].y < 0) bullets.splice(i,1);
        }

        for(let i=powerups.length-1; i>=0; i--) {
            let p = powerups[i];
            p.y += p.speed;
            let hit = false;
            if(Math.hypot(player.x-p.x, player.y-p.y) < 40) { activatePowerup(p); hit=true; }
            if(!hit) {
                for(let j=bullets.length-1; j>=0; j--) {
                    if(Math.hypot(bullets[j].x-p.x, bullets[j].y-p.y) < 30) {
                        activatePowerup(p); 
                        bullets.splice(j,1);
                        hit=true; break;
                    }
                }
            }
            if(hit) powerups.splice(i,1);
            else if(p.y > height) powerups.splice(i,1);
        }

        for(let i=asteroids.length-1; i>=0; i--) {
            let a = asteroids[i];
            a.y += a.speed;
            if(a.y > height) {
                if(a.isCorrect) {
                    playerTakeDamage(); 
                    asteroids.splice(i,1);
                    if(lives > 0 && asteroids.length === 0) spawnAsteroids(gameDeck[wordIndex]); 
                    return;
                }
                asteroids.splice(i,1);
                continue;
            }
            for(let j=bullets.length-1; j>=0; j--) {
                let b = bullets[j];
                if(b.x > a.x && b.x < a.x+a.w && b.y > a.y && b.y < a.y+a.h) {
                    bullets.splice(j,1);
                    if(a.isCorrect) {
                        score += 10; wordIndex++; loadQuestion(); return;
                    } else {
                        playerTakeDamage();
                        asteroids.splice(i,1);
                        if(lives > 0 && asteroids.length === 0) spawnAsteroids(gameDeck[wordIndex]);
                        return;
                    }
                }
            }
        }
        if(asteroids.length === 0 && gameState === 'PLAYING') spawnAsteroids(gameDeck[wordIndex]);
        particles.forEach((p,i)=>{ p.x+=p.vx; p.y+=p.vy; p.life-=0.05; if(p.life<=0) particles.splice(i,1); });
        stars.forEach(s => { s.y += s.speed; if(s.y>height) s.y=0; });
    }

    function draw() {
        ctx.fillStyle = '#0d0e15'; ctx.fillRect(0,0,width,height);
        ctx.fillStyle = 'white'; stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x,s.y,1,0,7); ctx.fill(); });
        if(gameState === 'PLAYING') {
            ctx.fillStyle = player.color;
            ctx.beginPath(); ctx.moveTo(player.x, player.y-25); ctx.lineTo(player.x-20, player.y+20); ctx.lineTo(player.x+20, player.y+20); ctx.fill();
            asteroids.forEach(a => {
                ctx.fillStyle = '#636e72'; ctx.fillRect(a.x, a.y, a.w, a.h);
                ctx.fillStyle = 'white'; ctx.font = '16px Arial'; ctx.textAlign = 'center';
                ctx.fillText(a.text, a.x+a.w/2, a.y+30);
            });
            bullets.forEach(b => { ctx.fillStyle=b.color; ctx.fillRect(b.x-3, b.y, b.w, b.h); });
            powerups.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 15, 0, 7); ctx.fill();
                ctx.fillStyle = 'white'; ctx.fillText(p.symbol, p.x, p.y+5);
            });
            particles.forEach(p=>{ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;});
        }
    }
</script>
</body>
</html>
